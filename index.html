<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Top 10 Weather Day - Twin Cities</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 16px;
        }

        .container {
            max-width: 420px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.96);
            border-radius: 24px;
            padding: 24px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(20px);
        }

        .header {
            text-align: center;
            margin-bottom: 24px;
        }

        .logo {
            font-size: 52px;
            margin-bottom: 12px;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.1));
        }

        h1 {
            color: #2d3748;
            font-size: 26px;
            font-weight: 700;
            margin-bottom: 8px;
            line-height: 1.2;
        }

        .subtitle {
            color: #4a5568;
            font-size: 15px;
            line-height: 1.4;
            font-weight: 500;
        }

        .auth-section {
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 24px;
            border: 1px solid rgba(226, 232, 240, 0.5);
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        .input-group {
            margin-bottom: 16px;
        }

        .input-group label {
            display: block;
            color: #4a5568;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .input-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 16px;
            background: white;
            transition: border-color 0.2s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
        }

        .auth-btn {
            width: 100%;
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
            color: white;
            border: none;
            padding: 14px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 12px;
        }

        .auth-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(66, 153, 225, 0.3);
        }

        .auth-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .auth-toggle {
            text-align: center;
            color: #4a5568;
            font-size: 14px;
        }

        .auth-toggle button {
            background: none;
            border: none;
            color: #4299e1;
            font-weight: 600;
            cursor: pointer;
            text-decoration: underline;
        }

        .user-welcome {
            text-align: center;
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 24px;
        }

        .user-welcome h3 {
            margin-bottom: 4px;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            margin-top: 8px;
        }

        .weather-card {
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
            border-radius: 20px;
            padding: 28px;
            margin: 24px 0;
            color: white;
            text-align: center;
            position: relative;
            overflow: hidden;
            box-shadow: 0 12px 24px rgba(66, 153, 225, 0.3);
        }

        .weather-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: conic-gradient(from 0deg, transparent, rgba(255,255,255,0.1), transparent);
            animation: rotate 6s linear infinite;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .weather-content {
            position: relative;
            z-index: 1;
        }

        .location {
            font-size: 16px;
            margin-bottom: 8px;
            opacity: 0.95;
            font-weight: 500;
        }

        .temperature {
            font-size: 56px;
            font-weight: 200;
            margin: 12px 0;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .conditions {
            font-size: 20px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .weather-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-top: 20px;
        }

        .detail-card {
            background: rgba(255, 255, 255, 0.15);
            padding: 14px;
            border-radius: 12px;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .detail-label {
            font-size: 12px;
            opacity: 0.85;
            margin-bottom: 6px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .detail-value {
            font-size: 18px;
            font-weight: 600;
        }

        .question-section {
            text-align: center;
            margin: 32px 0 24px;
            padding: 20px;
            background: rgba(247, 250, 252, 0.8);
            border-radius: 16px;
            border: 1px solid rgba(226, 232, 240, 0.5);
        }

        .question-section h2 {
            color: #2d3748;
            font-size: 22px;
            margin-bottom: 12px;
            font-weight: 700;
        }

        .question-section p {
            color: #4a5568;
            font-size: 15px;
            line-height: 1.5;
            font-weight: 500;
        }

        .vote-buttons {
            display: flex;
            gap: 16px;
            margin: 28px 0;
        }

        .vote-btn {
            flex: 1;
            padding: 20px 16px;
            border: none;
            border-radius: 16px;
            font-size: 17px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .vote-btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 12px 28px rgba(0, 0, 0, 0.2);
        }

        .vote-btn:active {
            transform: translateY(-1px);
        }

        .vote-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .yes-btn {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            box-shadow: 0 8px 20px rgba(72, 187, 120, 0.3);
        }

        .no-btn {
            background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
            color: white;
            box-shadow: 0 8px 20px rgba(237, 137, 54, 0.3);
        }

        .feedback {
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
            border-radius: 16px;
            padding: 24px;
            margin: 24px 0;
            text-align: center;
            border-left: 4px solid #48bb78;
            display: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .feedback.show {
            animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .feedback.error {
            border-left-color: #e53e3e;
            background: linear-gradient(135deg, #fed7d7 0%, #feb2b2 100%);
        }

        @keyframes slideUp {
            from { 
                opacity: 0; 
                transform: translateY(20px) scale(0.95); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
        }

        .stats-section {
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
            border-radius: 18px;
            padding: 24px;
            margin-top: 28px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .stats-header {
            color: #2d3748;
            margin-bottom: 20px;
            text-align: center;
            font-size: 20px;
            font-weight: 700;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 14px;
            padding: 12px 0;
            border-bottom: 1px solid rgba(226, 232, 240, 0.6);
        }

        .stat-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .stat-label {
            color: #4a5568;
            font-weight: 600;
            font-size: 15px;
        }

        .stat-value {
            color: #2d3748;
            font-weight: 700;
            font-size: 18px;
            background: linear-gradient(135deg, #4299e1, #3182ce);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .loading {
            text-align: center;
            color: rgba(255, 255, 255, 0.9);
            font-style: italic;
            font-size: 16px;
            font-weight: 500;
        }

        .manual-input {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            padding: 20px;
            margin: 20px 0;
            border: 2px solid #e2e8f0;
            display: none;
        }

        .manual-input h3 {
            color: #2d3748;
            margin-bottom: 16px;
            text-align: center;
            font-size: 18px;
        }

        .input-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }

        .input-group.full-width {
            grid-column: 1 / -1;
        }

        .input-group select {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            background: white;
            transition: border-color 0.2s;
        }

        .manual-submit-btn {
            width: 100%;
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .manual-submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(66, 153, 225, 0.3);
        }

        .hidden {
            display: none !important;
        }

        @media (max-width: 480px) {
            .container {
                margin: 8px;
                padding: 20px;
                border-radius: 20px;
            }
            
            .temperature {
                font-size: 48px;
            }
            
            .vote-btn {
                padding: 18px 12px;
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">üå§Ô∏è</div>
            <h1>Top 10 Weather Day</h1>
            <p class="subtitle">Twin Cities weather crowdsourcing<br>Help us identify the most beautiful days!</p>
        </div>

        <!-- Authentication Section -->
        <div id="authSection" class="auth-section">
            <!-- Login Form -->
            <div id="loginForm" class="auth-form active">
                <h3 style="text-align: center; margin-bottom: 16px; color: #2d3748;">Welcome Back!</h3>
                <div class="input-group">
                    <label for="loginEmail">Email</label>
                    <input type="email" id="loginEmail" placeholder="your@email.com" required>
                </div>
                <div class="input-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" placeholder="Your password" required>
                </div>
                <button class="auth-btn" id="loginBtn">Sign In</button>
                <div class="auth-toggle">
                    Don't have an account? <button onclick="showSignup()">Create one here</button>
                </div>
            </div>

            <!-- Signup Form -->
            <div id="signupForm" class="auth-form">
                <h3 style="text-align: center; margin-bottom: 16px; color: #2d3748;">Join the Community!</h3>
                <div class="input-group">
                    <label for="signupName">Name</label>
                    <input type="text" id="signupName" placeholder="Your name" required>
                </div>
                <div class="input-group">
                    <label for="signupEmail">Email</label>
                    <input type="email" id="signupEmail" placeholder="your@email.com" required>
                </div>
                <div class="input-group">
                    <label for="signupPassword">Password</label>
                    <input type="password" id="signupPassword" placeholder="Choose a password" required>
                </div>
                <button class="auth-btn" id="signupBtn">Create Account</button>
                <div class="auth-toggle">
                    Already have an account? <button onclick="showLogin()">Sign in here</button>
                </div>
            </div>
        </div>

        <!-- Email Confirmation Screen (hidden initially) -->
        <div id="emailConfirmationScreen" class="auth-section hidden">
            <div style="text-align: center;">
                <div style="font-size: 64px; margin-bottom: 20px;">üìß</div>
                <h2 style="color: #2d3748; margin-bottom: 16px; font-size: 24px;">Check Your Email!</h2>
                <p style="color: #4a5568; margin-bottom: 8px; font-size: 16px;">We've sent a confirmation link to:</p>
                <div style="background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%); color: white; padding: 12px 20px; border-radius: 12px; font-weight: 600; margin: 16px 0; display: inline-block; font-size: 16px;" id="confirmationEmailDisplay"></div>
                <p style="color: #4a5568; margin-bottom: 24px; line-height: 1.5;">Click the link in your email to activate your account and start voting on weather!</p>
                
                <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; margin-top: 24px;">
                    <button class="auth-btn" onclick="backToLogin()" style="flex: 1; max-width: 200px; background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);">
                        ‚úÖ Got it!
                    </button>
                    <button class="auth-btn" onclick="resendConfirmationEmail()" style="flex: 1; max-width: 200px; background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);">
                        üìÆ Resend Email
                    </button>
                </div>
                
                <p style="color: #718096; font-size: 14px; margin-top: 20px; line-height: 1.4;">
                    Don't see the email? Check your spam folder or try resending.<br>
                    The confirmation link will expire in 24 hours.
                </p>
            </div>
        </div>

        <!-- User Welcome Section (hidden initially) -->
        <div id="userWelcome" class="user-welcome hidden">
            <h3>Welcome back, <span id="userName"></span>! üëã</h3>
            <p id="userStatus">Ready to vote on today's weather?</p>
            <button class="logout-btn" onclick="handleLogout()">Logout</button>
        </div>

        <!-- Main App Content (hidden until logged in) -->
        <div id="mainContent" class="hidden">
            <div id="weatherCard" class="weather-card">
                <div class="weather-content">
                    <div class="loading">Loading Minneapolis weather...</div>
                </div>
            </div>

            <div id="manualInput" class="manual-input">
                <h3>‚ö° Enter Current Weather Conditions</h3>
                <div class="input-grid">
                    <div class="input-group">
                        <label for="manualTemp">Temperature (¬∞F)</label>
                        <input type="number" id="manualTemp" placeholder="72" min="-50" max="120">
                    </div>
                    <div class="input-group">
                        <label for="manualFeelsLike">Feels Like (¬∞F)</label>
                        <input type="number" id="manualFeelsLike" placeholder="75" min="-50" max="120">
                    </div>
                    <div class="input-group full-width">
                        <label for="manualConditions">Weather Conditions</label>
                        <select id="manualConditions">
                            <option value="">Select conditions...</option>
                            <option value="Sunny">Sunny</option>
                            <option value="Partly Cloudy">Partly Cloudy</option>
                            <option value="Cloudy">Cloudy</option>
                            <option value="Light Rain">Light Rain</option>
                            <option value="Rain">Rain</option>
                            <option value="Thunderstorms">Thunderstorms</option>
                            <option value="Snow">Snow</option>
                            <option value="Fog">Fog</option>
                            <option value="Windy">Windy</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="manualHumidity">Humidity (%)</label>
                        <input type="number" id="manualHumidity" placeholder="55" min="0" max="100">
                    </div>
                    <div class="input-group">
                        <label for="manualWind">Wind Speed (mph)</label>
                        <input type="number" id="manualWind" placeholder="7" min="0" max="200">
                    </div>
                </div>
                <button class="manual-submit-btn" onclick="submitManualWeather()" id="manualSubmitBtn">
                    Use This Weather Data
                </button>
            </div>

            <div class="question-section">
                <h2>Is today a "Top 10" weather day?</h2>
                <p>Would you consider today's weather to be one of the 10 best days of the year in the Twin Cities?</p>
            </div>

            <div class="vote-buttons">
                <button class="vote-btn yes-btn" onclick="submitVote(true)" id="yesBtn">
                    üëç Yes!
                </button>
                <button class="vote-btn no-btn" onclick="submitVote(false)" id="noBtn">
                    üëé Not quite
                </button>
            </div>

            <div id="feedback" class="feedback">
                <h3>Thank you!</h3>
                <p>Your response helps us understand what makes a perfect weather day in the Twin Cities.</p>
            </div>

            <div class="stats-section">
                <h3 class="stats-header">üìä Today's Community Votes</h3>
                <div class="stat-item">
                    <span class="stat-label">üåü Top 10 Day Votes</span>
                    <span class="stat-value" id="yesCount">Loading...</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">üòê Regular Day Votes</span>
                    <span class="stat-value" id="noCount">Loading...</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">üìà Total Responses</span>
                    <span class="stat-value" id="totalCount">Loading...</span>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <script>
        // Configuration
        const config = {
            supabaseUrl: 'https://qydykruzcngqaskudwsy.supabase.co',
            supabaseKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF5ZHlrcnV6Y25ncWFza3Vkd3N5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkwMDA0NjcsImV4cCI6MjA2NDU3NjQ2N30.XsPo7tmgmszRYsWayAFr9IlA4JS8hd9Y9FEght2ktHk',
            weatherApiKey: '80d6e7abc10f400ebc713153250406'
        };

        // Initialize Supabase
        const { createClient } = supabase;
        const supabaseClient = createClient(config.supabaseUrl, config.supabaseKey);

        // App state
        let currentWeatherData = null;
        let weatherLoadTimeout = null;
        let isManualMode = false;
        let currentUser = null;
        let hasVotedToday = false;

        // Initialize app when DOM loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ App initializing...');
            
            // Set up event listeners
            document.getElementById('signupBtn').addEventListener('click', function() {
                console.log('Signup button clicked!');
                handleSignup();
            });
            
            document.getElementById('loginBtn').addEventListener('click', handleLogin);
            
            checkAuthState();
        });

        // Check if user is already logged in
        async function checkAuthState() {
            try {
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (session) {
                    currentUser = session.user;
                    showMainApp();
                    await checkIfVotedToday();
                    loadWeatherData();
                    loadTodaysStats();
                    setupMidnightReset();
                } else {
                    showAuthSection();
                }
            } catch (error) {
                console.error('‚ùå Error checking auth state:', error);
                showAuthSection();
            }
        }

        // Show authentication section
        function showAuthSection() {
            document.getElementById('authSection').classList.remove('hidden');
            document.getElementById('userWelcome').classList.add('hidden');
            document.getElementById('mainContent').classList.add('hidden');
        }

        // Show main app content
        function showMainApp() {
            document.getElementById('authSection').classList.add('hidden');
            document.getElementById('userWelcome').classList.remove('hidden');
            document.getElementById('mainContent').classList.remove('hidden');
            
            // Update user welcome
            const userName = currentUser.user_metadata?.name || currentUser.email.split('@')[0];
            document.getElementById('userName').textContent = userName;
        }

        // Show login form
        function showLogin() {
            document.getElementById('loginForm').classList.add('active');
            document.getElementById('signupForm').classList.remove('active');
        }

        // Show signup form
        function showSignup() {
            document.getElementById('signupForm').classList.add('active');
            document.getElementById('loginForm').classList.remove('active');
        }

        // Handle user login
        async function handleLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const loginBtn = document.getElementById('loginBtn');

            if (!email || !password) {
                showFeedback('Please enter both email and password', true);
                return;
            }

            loginBtn.disabled = true;
            loginBtn.textContent = 'Signing In...';

            try {
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email: email,
                    password: password
                });

                if (error) throw error;

                currentUser = data.user;
                console.log('‚úÖ User logged in successfully');
                showMainApp();
                await checkIfVotedToday();
                loadWeatherData();
                loadTodaysStats();
                setupMidnightReset();

            } catch (error) {
                console.error('‚ùå Login error:', error);
                showFeedback(error.message, true);
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = 'Sign In';
            }
        }

        // Handle user signup
        async function handleSignup() {
            console.log('üîç handleSignup function called!');
            
            const name = document.getElementById('signupName').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const signupBtn = document.getElementById('signupBtn');

            console.log('üîç Form values:', { name, email, password: password ? '[hidden]' : 'empty' });

            if (!name || !email || !password) {
                showFeedback('Please fill in all fields', true);
                return;
            }

            if (password.length < 6) {
                showFeedback('Password must be at least 6 characters', true);
                return;
            }

            signupBtn.disabled = true;
            signupBtn.textContent = 'Creating Account...';

            try {
                console.log('üîç Calling Supabase signUp...');
                
                const { data, error } = await supabaseClient.auth.signUp({
                    email: email,
                    password: password,
                    options: {
                        data: {
                            name: name
                        },
                        emailRedirectTo: window.location.origin
                    }
                });

                console.log('üîç Supabase response:', { data, error });

                if (error) {
                    console.error('‚ùå Supabase error:', error);
                    throw error;
                }

                // Reset the signup button BEFORE showing confirmation screen
                signupBtn.disabled = false;
                signupBtn.textContent = 'Create Account';
                console.log('üîç Button reset completed');

                // Check what we got back from Supabase
                console.log('üîç Data object:', data);
                console.log('üîç User object:', data?.user);
                console.log('üîç Session object:', data?.session);

                // Always try to show email confirmation for any successful signup
                console.log('üîç About to call showEmailConfirmationMessage...');
                showEmailConfirmationMessage(email);

            } catch (error) {
                console.error('‚ùå Signup error:', error);
                showFeedback(`Signup failed: ${error.message}`, true);
                
                // Reset button on error
                signupBtn.disabled = false;
                signupBtn.textContent = 'Create Account';
            }
        // Show email confirmation screen (replaces auth forms)
        function showEmailConfirmationMessage(email) {
            console.log('üîç Starting showEmailConfirmationMessage with email:', email);
            
            const authSection = document.getElementById('authSection');
            const emailConfirmationScreen = document.getElementById('emailConfirmationScreen');
            const emailDisplay = document.getElementById('confirmationEmailDisplay');
            
            console.log('üîç Elements found:', {
                authSection: !!authSection,
                emailConfirmationScreen: !!emailConfirmationScreen,
                emailDisplay: !!emailDisplay
            });
            
            if (!authSection || !emailConfirmationScreen || !emailDisplay) {
                console.error('‚ùå Missing required elements for email confirmation');
                showFeedback('Please check your email to confirm your account!', false);
                return;
            }
            
            // Set the email in the display
            emailDisplay.textContent = email;
            console.log('‚úÖ Email set in display:', email);
            
            // Hide auth section and show confirmation screen
            authSection.classList.add('hidden');
            emailConfirmationScreen.classList.remove('hidden');
            
            console.log('‚úÖ Switched to email confirmation screen');
            console.log('üîç Auth section hidden:', authSection.classList.contains('hidden'));
            console.log('üîç Email screen visible:', !emailConfirmationScreen.classList.contains('hidden'));
        }

        // Go back to login screen
        function backToLogin() {
            const authSection = document.getElementById('authSection');
            const emailConfirmationScreen = document.getElementById('emailConfirmationScreen');
            
            // Hide confirmation screen and show auth section
            emailConfirmationScreen.classList.add('hidden');
            authSection.classList.remove('hidden');
            
            // Show login form specifically
            showLogin();
            
            showFeedback('Great! Once you confirm your email, you can sign in here.', false);
        }

        // Resend confirmation email
        async function resendConfirmationEmail() {
            const email = document.getElementById('confirmationEmailDisplay').textContent;
            
            try {
                const { error } = await supabaseClient.auth.resend({
                    type: 'signup',
                    email: email,
                    options: {
                        emailRedirectTo: window.location.origin
                    }
                });

                if (error) throw error;

                showFeedback('Confirmation email sent again! Check your inbox.', false);
                console.log(`üìß Resent confirmation email to: ${email}`);

            } catch (error) {
                console.error('‚ùå Error resending email:', error);
                showFeedback('Sorry, there was an error resending the email. Please try again.', true);
            }
        }
        // Handle user logout
        async function handleLogout() {
            try {
                await supabaseClient.auth.signOut();
                currentUser = null;
                hasVotedToday = false;
                showAuthSection();
                console.log('‚úÖ User logged out');
            } catch (error) {
                console.error('‚ùå Logout error:', error);
            }
        }

        // Check if user has voted today
        async function checkIfVotedToday() {
            if (!currentUser) return;

            try {
                const today = new Date().toISOString().split('T')[0];
                
                const { data, error } = await supabaseClient
                    .from('weather_votes')
                    .select('id')
                    .eq('user_id', currentUser.id)
                    .eq('date', today);

                if (error) throw error;

                hasVotedToday = data.length > 0;
                updateVoteButtonsState();

            } catch (error) {
                console.error('‚ùå Error checking vote status:', error);
            }
        }

        // Update vote buttons based on whether user has voted
            const yesBtn = document.getElementById('yesBtn');
            const noBtn = document.getElementById('noBtn');
            const questionSection = document.querySelector('.question-section');
            const userStatus = document.getElementById('userStatus');
            
            if (hasVotedToday) {
                yesBtn.disabled = true;
                noBtn.disabled = true;
                yesBtn.textContent = '‚úÖ Voted Today';
                noBtn.textContent = '‚úÖ Voted Today';
                
                questionSection.innerHTML = `
                    <h2>Thanks for voting today!</h2>
                    <p>You can vote again tomorrow. Check back at midnight for a fresh vote!</p>
                `;
                
                userStatus.textContent = 'You\'ve already voted today! Come back tomorrow.';
            } else {
                yesBtn.disabled = false;
                noBtn.disabled = false;
                yesBtn.textContent = 'üëç Yes!';
                noBtn.textContent = 'üëé Not quite';
                
                questionSection.innerHTML = `
                    <h2>Is today a "Top 10" weather day?</h2>
                    <p>Would you consider today's weather to be one of the 10 best days of the year in the Twin Cities?</p>
                `;
                
                userStatus.textContent = 'Ready to vote on today\'s weather?';
            }
        }

        // Set up automatic reset at midnight
        function setupMidnightReset() {
            const now = new Date();
            const tomorrow = new Date(now);
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setHours(0, 0, 0, 0);
            
            const msUntilMidnight = tomorrow.getTime() - now.getTime();
            
            setTimeout(() => {
                console.log('üïõ Midnight reset triggered');
                hasVotedToday = false;
                updateVoteButtonsState();
                loadTodaysStats();
                setupMidnightReset(); // Set up next midnight reset
            }, msUntilMidnight);
            
            console.log(`‚è∞ Next reset in ${Math.round(msUntilMidnight / 1000 / 60)} minutes`);
        }

        // Load Minneapolis weather data
        async function loadWeatherData() {
            try {
                console.log('üå§Ô∏è Loading weather data...');
                
                const response = await fetch(
                    `https://api.weatherapi.com/v1/current.json?key=${config.weatherApiKey}&q=Minneapolis,MN&aqi=no`
                );

                if (!response.ok) {
                    throw new Error(`Weather API error: ${response.status}`);
                }

                const data = await response.json();
                console.log('‚úÖ Weather data loaded successfully');
                
                // Clear the timeout since we got data
                if (weatherLoadTimeout) {
                    clearTimeout(weatherLoadTimeout);
                }
                
                currentWeatherData = {
                    location: `${data.location.name}, ${data.location.region}`,
                    temperature: Math.round(data.current.temp_f),
                    conditions: data.current.condition.text,
                    humidity: data.current.humidity,
                    windSpeed: Math.round(data.current.wind_mph),
                    uvIndex: data.current.uv,
                    feelsLike: Math.round(data.current.feelslike_f),
                    pressure: Math.round(data.current.pressure_in * 100) / 100,
                    visibility: Math.round(data.current.vis_miles),
                    timestamp: new Date().toISOString(),
                    isManualEntry: false
                };
                
                displayWeatherData();

            } catch (error) {
                console.error('‚ùå Error loading weather:', error);
                console.log('üîÑ Weather API failed - will show manual input after timeout');
                
                // Set 10-second timeout for manual input fallback
                weatherLoadTimeout = setTimeout(() => {
                    if (!currentWeatherData) {
                        console.log('‚è∞ Weather API timeout - switching to manual input');
                        showManualInput();
                    }
                }, 10000);
            }
        }

        // Show manual input form
        function showManualInput() {
            document.getElementById('weatherCard').innerHTML = `
                <div class="weather-content">
                    <div class="loading">‚ö° Couldn't load weather data automatically.<br>Please enter current conditions below.</div>
                </div>
            `;
            document.getElementById('manualInput').style.display = 'block';
            isManualMode = true;
        }

        // Submit manual weather data
        function submitManualWeather() {
            const temp = document.getElementById('manualTemp').value;
            const feelsLike = document.getElementById('manualFeelsLike').value;
            const conditions = document.getElementById('manualConditions').value;
            const humidity = document.getElementById('manualHumidity').value;
            const wind = document.getElementById('manualWind').value;

            // Validation
            if (!temp || !conditions) {
                showFeedback('Please enter at least temperature and weather conditions', true);
                return;
            }

            // Create weather data object
            currentWeatherData = {
                location: "Minneapolis, MN (Manual Entry)",
                temperature: parseInt(temp),
                conditions: conditions,
                humidity: parseInt(humidity) || 50,
                windSpeed: parseInt(wind) || 0,
                uvIndex: 5, // Default
                feelsLike: parseInt(feelsLike) || parseInt(temp),
                pressure: 30.00, // Default
                visibility: 10, // Default
                timestamp: new Date().toISOString(),
                isManualEntry: true
            };

            // Hide manual input and show weather data
            document.getElementById('manualInput').style.display = 'none';
            displayWeatherData();
            
            console.log('‚úÖ Manual weather data submitted');
        }

        // Display weather data in the UI
        function displayWeatherData() {
            const weatherCard = document.getElementById('weatherCard');
            const manualIndicator = currentWeatherData.isManualEntry ? 
                '<div style="background: rgba(255,193,7,0.2); padding: 4px 8px; border-radius: 6px; font-size: 12px; margin-bottom: 8px;">üìù Manual Entry</div>' : '';
            
            weatherCard.innerHTML = `
                <div class="weather-content">
                    ${manualIndicator}
                    <div class="location">${currentWeatherData.location}</div>
                    <div class="temperature">${currentWeatherData.temperature}¬∞F</div>
                    <div class="conditions">${currentWeatherData.conditions}</div>
                    <div class="weather-details">
                        <div class="detail-card">
                            <div class="detail-label">Feels Like</div>
                            <div class="detail-value">${currentWeatherData.feelsLike}¬∞F</div>
                        </div>
                        <div class="detail-card">
                            <div class="detail-label">Humidity</div>
                            <div class="detail-value">${currentWeatherData.humidity}%</div>
                        </div>
                        <div class="detail-card">
                            <div class="detail-label">Wind</div>
                            <div class="detail-value">${currentWeatherData.windSpeed} mph</div>
                        </div>
                        <div class="detail-card">
                            <div class="detail-label">UV Index</div>
                            <div class="detail-value">${currentWeatherData.uvIndex}</div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Submit a vote
        async function submitVote(isTop10) {
            // Check authentication
            if (!currentUser) {
                showFeedback('Please log in to vote!', true);
                return;
            }

            // Check if user already voted today
            if (hasVotedToday) {
                showFeedback('You have already voted today! Come back tomorrow for a fresh vote.', true);
                return;
            }

            if (!currentWeatherData) {
                showFeedback('Please wait for weather data to load!', true);
                return;
            }

            // Disable buttons during submission
            const yesBtn = document.getElementById('yesBtn');
            const noBtn = document.getElementById('noBtn');
            yesBtn.disabled = true;
            noBtn.disabled = true;

            try {
                console.log(`üó≥Ô∏è Submitting vote: ${isTop10 ? 'YES' : 'NO'} for user ${currentUser.id}`);

                const voteData = {
                    user_id: currentUser.id,
                    user_email: currentUser.email,
                    is_top10: isTop10,
                    temperature: currentWeatherData.temperature,
                    conditions: currentWeatherData.conditions,
                    humidity: currentWeatherData.humidity,
                    wind_speed: currentWeatherData.windSpeed,
                    uv_index: currentWeatherData.uvIndex,
                    feels_like: currentWeatherData.feelsLike,
                    pressure: currentWeatherData.pressure,
                    visibility: currentWeatherData.visibility,
                    location: currentWeatherData.location,
                    user_agent: navigator.userAgent,
                    is_manual_entry: currentWeatherData.isManualEntry || false
                };

                console.log('üì§ Vote data being sent:', voteData);

                const { data, error } = await supabaseClient
                    .from('weather_votes')
                    .insert([voteData]);

                if (error) {
                    console.error('‚ùå Supabase error details:', error);
                    throw error;
                }

                console.log('‚úÖ Vote submitted successfully', data);
                
                // Mark user as having voted today
                hasVotedToday = true;
                updateVoteButtonsState();
                
                showFeedback(
                    isTop10 
                        ? 'Thanks! You think today is a Top 10 weather day! üåü Come back tomorrow to vote again!' 
                        : 'Thanks! Every day helps us learn what makes perfect weather! üëç Come back tomorrow to vote again!',
                    false
                );
                
                // Refresh stats
                setTimeout(() => loadTodaysStats(), 500);

            } catch (error) {
                console.error('‚ùå Full error object:', error);
                console.error('‚ùå Error message:', error.message);
                console.error('‚ùå Error details:', error.details);
                console.error('‚ùå Error hint:', error.hint);
                
                let errorMessage = 'Sorry, there was an error submitting your vote.';
                if (error.message) {
                    errorMessage += ` Error: ${error.message}`;
                }
                
                showFeedback(errorMessage, true);
                
                // Re-enable buttons on error
                yesBtn.disabled = false;
                noBtn.disabled = false;
            }
        }

        // Load today's voting statistics
        async function loadTodaysStats() {
            if (!supabaseClient) {
                console.error('‚ùå Supabase client not initialized');
                document.getElementById('yesCount').textContent = 'Error';
                document.getElementById('noCount').textContent = 'Error';
                document.getElementById('totalCount').textContent = 'Error';
                return;
            }

            try {
                console.log('üìä Loading today\'s stats...');
                const today = new Date().toISOString().split('T')[0];
                console.log('üìÖ Today\'s date:', today);
                
                const { data, error } = await supabaseClient
                    .from('weather_votes')
                    .select('is_top10')
                    .eq('date', today);

                if (error) {
                    console.error('‚ùå Supabase query error:', error);
                    throw error;
                }

                console.log('üìä Raw stats data:', data);

                const yesVotes = data.filter(vote => vote.is_top10).length;
                const noVotes = data.filter(vote => !vote.is_top10).length;
                const totalVotes = data.length;

                document.getElementById('yesCount').textContent = yesVotes;
                document.getElementById('noCount').textContent = noVotes;
                document.getElementById('totalCount').textContent = totalVotes;

                console.log(`üìä Stats loaded: ${yesVotes} yes, ${noVotes} no, ${totalVotes} total`);

            } catch (error) {
                console.error('‚ùå Error loading stats:', error);
                console.error('‚ùå Error details:', error.message);
                document.getElementById('yesCount').textContent = '0';
                document.getElementById('noCount').textContent = '0';
                document.getElementById('totalCount').textContent = '0';
            }
        }

        // Show feedback message
        function showFeedback(message, isError = false) {
            const feedback = document.getElementById('feedback');
            feedback.innerHTML = `
                <h3>${isError ? 'Oops!' : 'Thank you!'}</h3>
                <p>${message}</p>
            `;
            feedback.className = `feedback show ${isError ? 'error' : ''}`;
            feedback.style.display = 'block';

            // Hide after 5 seconds
            setTimeout(() => {
                feedback.style.display = 'none';
                feedback.classList.remove('show');
            }, 5000);
        }

        // Listen for auth state changes
        supabaseClient.auth.onAuthStateChange((event, session) => {
            console.log('üîê Auth state changed:', event);
            if (event === 'SIGNED_IN') {
                currentUser = session.user;
                showMainApp();
                checkIfVotedToday();
                loadWeatherData();
                loadTodaysStats();
                setupMidnightReset();
            } else if (event === 'SIGNED_OUT') {
                currentUser = null;
                hasVotedToday = false;
                showAuthSection();
            }
        });

        // Log app info
        console.log('üå§Ô∏è Top 10 Weather Day - Twin Cities Edition');
        console.log('üì± Ready to collect community weather preferences!');
        console.log('üîê User authentication enabled');
    </script>
</body>
</html>
