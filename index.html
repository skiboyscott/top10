<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Top 10 Weather Day - Twin Cities</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 16px;
        }

        .container {
            max-width: 420px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.96);
            border-radius: 24px;
            padding: 24px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(20px);
        }

        .header {
            text-align: center;
            margin-bottom: 24px;
        }

        .logo {
            font-size: 52px;
            margin-bottom: 12px;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.1));
        }

        h1 {
            color: #2d3748;
            font-size: 26px;
            font-weight: 700;
            margin-bottom: 8px;
            line-height: 1.2;
        }

        .subtitle {
            color: #4a5568;
            font-size: 15px;
            line-height: 1.4;
            font-weight: 500;
        }

        .weather-card {
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
            border-radius: 20px;
            padding: 28px;
            margin: 24px 0;
            color: white;
            text-align: center;
            position: relative;
            overflow: hidden;
            box-shadow: 0 12px 24px rgba(66, 153, 225, 0.3);
        }

        .weather-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: conic-gradient(from 0deg, transparent, rgba(255,255,255,0.1), transparent);
            animation: rotate 6s linear infinite;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .weather-content {
            position: relative;
            z-index: 1;
        }

        .location {
            font-size: 16px;
            margin-bottom: 8px;
            opacity: 0.95;
            font-weight: 500;
        }

        .temperature {
            font-size: 56px;
            font-weight: 200;
            margin: 12px 0;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .conditions {
            font-size: 20px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .weather-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-top: 20px;
        }

        .detail-card {
            background: rgba(255, 255, 255, 0.15);
            padding: 14px;
            border-radius: 12px;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .detail-label {
            font-size: 12px;
            opacity: 0.85;
            margin-bottom: 6px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .detail-value {
            font-size: 18px;
            font-weight: 600;
        }

        .question-section {
            text-align: center;
            margin: 32px 0 24px;
            padding: 20px;
            background: rgba(247, 250, 252, 0.8);
            border-radius: 16px;
            border: 1px solid rgba(226, 232, 240, 0.5);
        }

        .question-section h2 {
            color: #2d3748;
            font-size: 22px;
            margin-bottom: 12px;
            font-weight: 700;
        }

        .question-section p {
            color: #4a5568;
            font-size: 15px;
            line-height: 1.5;
            font-weight: 500;
        }

        .vote-buttons {
            display: flex;
            gap: 16px;
            margin: 28px 0;
        }

        .vote-btn {
            flex: 1;
            padding: 20px 16px;
            border: none;
            border-radius: 16px;
            font-size: 17px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .vote-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 28px rgba(0, 0, 0, 0.2);
        }

        .vote-btn:active {
            transform: translateY(-1px);
        }

        .vote-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .yes-btn {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            box-shadow: 0 8px 20px rgba(72, 187, 120, 0.3);
        }

        .no-btn {
            background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
            color: white;
            box-shadow: 0 8px 20px rgba(237, 137, 54, 0.3);
        }

        .feedback {
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
            border-radius: 16px;
            padding: 24px;
            margin: 24px 0;
            text-align: center;
            border-left: 4px solid #48bb78;
            display: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .feedback.show {
            animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .feedback.error {
            border-left-color: #e53e3e;
            background: linear-gradient(135deg, #fed7d7 0%, #feb2b2 100%);
        }

        @keyframes slideUp {
            from { 
                opacity: 0; 
                transform: translateY(20px) scale(0.95); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
        }

        .stats-section {
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
            border-radius: 18px;
            padding: 24px;
            margin-top: 28px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .stats-header {
            color: #2d3748;
            margin-bottom: 20px;
            text-align: center;
            font-size: 20px;
            font-weight: 700;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 14px;
            padding: 12px 0;
            border-bottom: 1px solid rgba(226, 232, 240, 0.6);
        }

        .stat-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .stat-label {
            color: #4a5568;
            font-weight: 600;
            font-size: 15px;
        }

        .stat-value {
            color: #2d3748;
            font-weight: 700;
            font-size: 18px;
            background: linear-gradient(135deg, #4299e1, #3182ce);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .loading {
            text-align: center;
            color: rgba(255, 255, 255, 0.9);
            font-style: italic;
            font-size: 16px;
            font-weight: 500;
        }

        .manual-input {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            padding: 20px;
            margin: 20px 0;
            border: 2px solid #e2e8f0;
            display: none;
        }

        .manual-input h3 {
            color: #2d3748;
            margin-bottom: 16px;
            text-align: center;
            font-size: 18px;
        }

        .input-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        .input-group.full-width {
            grid-column: 1 / -1;
        }

        .input-group label {
            color: #4a5568;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .input-group input,
        .input-group select {
            padding: 10px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            background: white;
            transition: border-color 0.2s;
        }

        .input-group input:focus,
        .input-group select:focus {
            outline: none;
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
        }

        .manual-submit-btn {
            width: 100%;
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .manual-submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(66, 153, 225, 0.3);
        }

        .manual-submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        @media (max-width: 480px) {
            .container {
                margin: 8px;
                padding: 20px;
                border-radius: 20px;
            }
            
            .temperature {
                font-size: 48px;
            }
            
            .vote-btn {
                padding: 18px 12px;
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">üå§Ô∏è</div>
            <h1>Top 10 Weather Day</h1>
            <p class="subtitle">Twin Cities weather crowdsourcing<br>Help us identify the most beautiful days!</p>
        </div>

        <div id="weatherCard" class="weather-card">
            <div class="weather-content">
                <div class="loading">Loading Minneapolis weather...</div>
            </div>
        </div>

        <div id="manualInput" class="manual-input">
            <h3>‚ö° Enter Current Weather Conditions</h3>
            <div class="input-grid">
                <div class="input-group">
                    <label for="manualTemp">Temperature (¬∞F)</label>
                    <input type="number" id="manualTemp" placeholder="72" min="-50" max="120">
                </div>
                <div class="input-group">
                    <label for="manualFeelsLike">Feels Like (¬∞F)</label>
                    <input type="number" id="manualFeelsLike" placeholder="75" min="-50" max="120">
                </div>
                <div class="input-group full-width">
                    <label for="manualConditions">Weather Conditions</label>
                    <select id="manualConditions">
                        <option value="">Select conditions...</option>
                        <option value="Sunny">Sunny</option>
                        <option value="Partly Cloudy">Partly Cloudy</option>
                        <option value="Cloudy">Cloudy</option>
                        <option value="Light Rain">Light Rain</option>
                        <option value="Rain">Rain</option>
                        <option value="Thunderstorms">Thunderstorms</option>
                        <option value="Snow">Snow</option>
                        <option value="Fog">Fog</option>
                        <option value="Windy">Windy</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="manualHumidity">Humidity (%)</label>
                    <input type="number" id="manualHumidity" placeholder="55" min="0" max="100">
                </div>
                <div class="input-group">
                    <label for="manualWind">Wind Speed (mph)</label>
                    <input type="number" id="manualWind" placeholder="7" min="0" max="200">
                </div>
            </div>
            <button class="manual-submit-btn" onclick="submitManualWeather()" id="manualSubmitBtn">
                Use This Weather Data
            </button>
        </div>

        <div class="question-section">
            <h2>Is today a "Top 10" weather day?</h2>
            <p>Would you consider today's weather to be one of the 10 best days of the year in the Twin Cities?</p>
        </div>

        <div class="vote-buttons">
            <button class="vote-btn yes-btn" onclick="submitVote(true)" id="yesBtn">
                üëç Yes!
            </button>
            <button class="vote-btn no-btn" onclick="submitVote(false)" id="noBtn">
                üëé Not quite
            </button>
        </div>

        <div id="feedback" class="feedback">
            <h3>Thank you!</h3>
            <p>Your response helps us understand what makes a perfect weather day in the Twin Cities.</p>
        </div>

        <div class="stats-section">
            <h3 class="stats-header">üìä Today's Community Votes</h3>
            <div class="stat-item">
                <span class="stat-label">üåü Top 10 Day Votes</span>
                <span class="stat-value" id="yesCount">Loading...</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">üòê Regular Day Votes</span>
                <span class="stat-value" id="noCount">Loading...</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">üìà Total Responses</span>
                <span class="stat-value" id="totalCount">Loading...</span>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <script>
        // Configuration
        const config = {
            supabaseUrl: 'https://qydykruzcngqaskudwsy.supabase.co',
            supabaseKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF5ZHlrcnV6Y25ncWFza3Vkd3N5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkwMDA0NjcsImV4cCI6MjA2NDU3NjQ2N30.XsPo7tmgmszRYsWayAFr9IlA4JS8hd9Y9FEght2ktHk',
            weatherApiKey: '80d6e7abc10f400ebc713153250406'
        };

        // Initialize Supabase
        const { createClient } = supabase;
        const supabaseClient = createClient(config.supabaseUrl, config.supabaseKey);

        // App state
        let currentWeatherData = null;
        let weatherLoadTimeout = null;
        let isManualMode = false;
        let hasVotedToday = false;
        let userSessionId = null;

        // Generate or retrieve user session ID
        function getUserSessionId() {
            let sessionId = localStorage.getItem('weatherapp_session_id');
            const lastVoteDate = localStorage.getItem('weatherapp_last_vote_date');
            const today = new Date().toISOString().split('T')[0];
            
            // Reset session if it's a new day
            if (lastVoteDate !== today) {
                sessionId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('weatherapp_session_id', sessionId);
                localStorage.setItem('weatherapp_last_vote_date', today);
                hasVotedToday = false;
            } else {
                // Check if user already voted today
                hasVotedToday = localStorage.getItem('weatherapp_voted_today') === 'true';
            }
            
            return sessionId;
        }

        // Initialize app when DOM loads
        function initializeApp() {
            console.log('üöÄ App initializing...');
            
            // Set up user session
            userSessionId = getUserSessionId();
            console.log('üë§ User session:', userSessionId);
            console.log('üó≥Ô∏è Has voted today:', hasVotedToday);
            
            // Update UI based on vote status
            updateVoteButtonsState();
            
            loadWeatherData();
            loadTodaysStats();
            
            // Set up midnight reset timer
            setupMidnightReset();
            
            // Set 10-second timeout for weather loading
            weatherLoadTimeout = setTimeout(() => {
                if (!currentWeatherData) {
                    console.log('‚è∞ Weather API timeout - switching to manual input');
                    showManualInput();
                }
            }, 10000);
        }

        // Set up automatic reset at midnight
        function setupMidnightReset() {
            const now = new Date();
            const tomorrow = new Date(now);
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setHours(0, 0, 0, 0);
            
            const msUntilMidnight = tomorrow.getTime() - now.getTime();
            
            setTimeout(() => {
                console.log('üïõ Midnight reset triggered');
                // Reset vote status
                hasVotedToday = false;
                localStorage.setItem('weatherapp_voted_today', 'false');
                localStorage.setItem('weatherapp_last_vote_date', new Date().toISOString().split('T')[0]);
                
                // Update UI
                updateVoteButtonsState();
                loadTodaysStats();
                
                // Set up next midnight reset
                setupMidnightReset();
            }, msUntilMidnight);
            
            console.log(`‚è∞ Next reset in ${Math.round(msUntilMidnight / 1000 / 60)} minutes`);
        }

        // Update vote buttons based on whether user has voted
        function updateVoteButtonsState() {
            const yesBtn = document.getElementById('yesBtn');
            const noBtn = document.getElementById('noBtn');
            const questionSection = document.querySelector('.question-section');
            
            if (hasVotedToday) {
                yesBtn.disabled = true;
                noBtn.disabled = true;
                yesBtn.textContent = '‚úÖ Voted Today';
                noBtn.textContent = '‚úÖ Voted Today';
                
                questionSection.innerHTML = `
                    <h2>Thanks for voting today!</h2>
                    <p>You can vote again tomorrow. Check back at midnight for a fresh vote!</p>
                `;
            } else {
                yesBtn.disabled = false;
                noBtn.disabled = false;
                yesBtn.textContent = 'üëç Yes!';
                noBtn.textContent = 'üëé Not quite';
                
                questionSection.innerHTML = `
                    <h2>Is today a "Top 10" weather day?</h2>
                    <p>Would you consider today's weather to be one of the 10 best days of the year in the Twin Cities?</p>
                `;
            }
        }

        // Show manual input form
        function showManualInput() {
            document.getElementById('weatherCard').innerHTML = `
                <div class="weather-content">
                    <div class="loading">‚ö° Couldn't load weather data automatically.<br>Please enter current conditions below.</div>
                </div>
            `;
            document.getElementById('manualInput').style.display = 'block';
            isManualMode = true;
        }

        // Submit manual weather data
        function submitManualWeather() {
            const temp = document.getElementById('manualTemp').value;
            const feelsLike = document.getElementById('manualFeelsLike').value;
            const conditions = document.getElementById('manualConditions').value;
            const humidity = document.getElementById('manualHumidity').value;
            const wind = document.getElementById('manualWind').value;

            // Validation
            if (!temp || !conditions) {
                alert('Please enter at least temperature and weather conditions');
                return;
            }

            // Create weather data object
            currentWeatherData = {
                location: "Minneapolis, MN (Manual Entry)",
                temperature: parseInt(temp),
                conditions: conditions,
                humidity: parseInt(humidity) || 50,
                windSpeed: parseInt(wind) || 0,
                uvIndex: 5, // Default
                feelsLike: parseInt(feelsLike) || parseInt(temp),
                pressure: 30.00, // Default
                visibility: 10, // Default
                timestamp: new Date().toISOString(),
                isManualEntry: true
            };

            // Hide manual input and show weather data
            document.getElementById('manualInput').style.display = 'none';
            displayWeatherData();
            
            console.log('‚úÖ Manual weather data submitted');
        }

        // Load Minneapolis weather data
        async function loadWeatherData() {
            try {
                console.log('üå§Ô∏è Loading weather data...');
                
                const response = await fetch(
                    `https://api.weatherapi.com/v1/current.json?key=${config.weatherApiKey}&q=Minneapolis,MN&aqi=no`
                );

                if (!response.ok) {
                    throw new Error(`Weather API error: ${response.status}`);
                }

                const data = await response.json();
                console.log('‚úÖ Weather data loaded successfully');
                
                // Clear the timeout since we got data
                if (weatherLoadTimeout) {
                    clearTimeout(weatherLoadTimeout);
                }
                
                currentWeatherData = {
                    location: `${data.location.name}, ${data.location.region}`,
                    temperature: Math.round(data.current.temp_f),
                    conditions: data.current.condition.text,
                    humidity: data.current.humidity,
                    windSpeed: Math.round(data.current.wind_mph),
                    uvIndex: data.current.uv,
                    feelsLike: Math.round(data.current.feelslike_f),
                    pressure: Math.round(data.current.pressure_in * 100) / 100,
                    visibility: Math.round(data.current.vis_miles),
                    timestamp: new Date().toISOString(),
                    isManualEntry: false
                };
                
                displayWeatherData();

            } catch (error) {
                console.error('‚ùå Error loading weather:', error);
                // Don't show fallback immediately - let the timeout handle it
                // This gives the user a chance to see the manual input option
            }
        }

        // Display weather data in the UI
        function displayWeatherData() {
            const weatherCard = document.getElementById('weatherCard');
            const manualIndicator = currentWeatherData.isManualEntry ? 
                '<div style="background: rgba(255,193,7,0.2); padding: 4px 8px; border-radius: 6px; font-size: 12px; margin-bottom: 8px;">üìù Manual Entry</div>' : '';
            
            weatherCard.innerHTML = `
                <div class="weather-content">
                    ${manualIndicator}
                    <div class="location">${currentWeatherData.location}</div>
                    <div class="temperature">${currentWeatherData.temperature}¬∞F</div>
                    <div class="conditions">${currentWeatherData.conditions}</div>
                    <div class="weather-details">
                        <div class="detail-card">
                            <div class="detail-label">Feels Like</div>
                            <div class="detail-value">${currentWeatherData.feelsLike}¬∞F</div>
                        </div>
                        <div class="detail-card">
                            <div class="detail-label">Humidity</div>
                            <div class="detail-value">${currentWeatherData.humidity}%</div>
                        </div>
                        <div class="detail-card">
                            <div class="detail-label">Wind</div>
                            <div class="detail-value">${currentWeatherData.windSpeed} mph</div>
                        </div>
                        <div class="detail-card">
                            <div class="detail-label">UV Index</div>
                            <div class="detail-value">${currentWeatherData.uvIndex}</div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Submit a vote
        async function submitVote(isTop10) {
            if (!currentWeatherData) {
                showFeedback('Please wait for weather data to load!', true);
                return;
            }

            // Disable buttons during submission
            const yesBtn = document.getElementById('yesBtn');
            const noBtn = document.getElementById('noBtn');
            yesBtn.disabled = true;
            noBtn.disabled = true;

            try {
                console.log(`üó≥Ô∏è Submitting vote: ${isTop10 ? 'YES' : 'NO'}`);

                const voteData = {
                    is_top10: isTop10,
                    temperature: currentWeatherData.temperature,
                    conditions: currentWeatherData.conditions,
                    humidity: currentWeatherData.humidity,
                    wind_speed: currentWeatherData.windSpeed,
                    uv_index: currentWeatherData.uvIndex,
                    feels_like: currentWeatherData.feelsLike,
                    pressure: currentWeatherData.pressure,
                    visibility: currentWeatherData.visibility,
                    location: currentWeatherData.location,
                    user_agent: navigator.userAgent,
                    vote_timestamp: new Date().toISOString(),
                    is_manual_entry: currentWeatherData.isManualEntry || false
                };

                const { data, error } = await supabaseClient
                    .from('weather_votes')
                    .insert([voteData]);

                if (error) {
                    throw error;
                }

                console.log('‚úÖ Vote submitted successfully');
                showFeedback(
                    isTop10 
                        ? 'Thanks! You think today is a Top 10 weather day! üåü' 
                        : 'Thanks! Every day helps us learn what makes perfect weather! üëç',
                    false
                );
                
                // Refresh stats
                setTimeout(() => loadTodaysStats(), 500);

            } catch (error) {
                console.error('‚ùå Error submitting vote:', error);
                showFeedback('Sorry, there was an error submitting your vote. Please try again!', true);
            } finally {
                // Re-enable buttons after delay
                setTimeout(() => {
                    yesBtn.disabled = false;
                    noBtn.disabled = false;
                }, 3000);
            }
        }

        // Load today's voting statistics
        async function loadTodaysStats() {
            try {
                const today = new Date().toISOString().split('T')[0];
                
                const { data, error } = await supabaseClient
                    .from('weather_votes')
                    .select('is_top10')
                    .eq('date', today);

                if (error) {
                    throw error;
                }

                const yesVotes = data.filter(vote => vote.is_top10).length;
                const noVotes = data.filter(vote => !vote.is_top10).length;
                const totalVotes = data.length;

                document.getElementById('yesCount').textContent = yesVotes;
                document.getElementById('noCount').textContent = noVotes;
                document.getElementById('totalCount').textContent = totalVotes;

                console.log(`üìä Stats loaded: ${yesVotes} yes, ${noVotes} no, ${totalVotes} total`);

            } catch (error) {
                console.error('‚ùå Error loading stats:', error);
                document.getElementById('yesCount').textContent = 'Error';
                document.getElementById('noCount').textContent = 'Error';
                document.getElementById('totalCount').textContent = 'Error';
            }
        }

        // Show feedback message
        function showFeedback(message, isError = false) {
            const feedback = document.getElementById('feedback');
            feedback.innerHTML = `
                <h3>${isError ? 'Oops!' : 'Thank you!'}</h3>
                <p>${message}</p>
            `;
            feedback.className = `feedback show ${isError ? 'error' : ''}`;
            feedback.style.display = 'block';

            // Hide after 5 seconds
            setTimeout(() => {
                feedback.style.display = 'none';
                feedback.classList.remove('show');
            }, 5000);
        }

        // Log app info
        console.log('üå§Ô∏è Top 10 Weather Day - Twin Cities Edition');
        console.log('üì± Ready to collect community weather preferences!');
    </script>
</body>
</html>
